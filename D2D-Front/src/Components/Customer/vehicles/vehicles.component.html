<div class="vehicles-container">
  <div class="header">
    <h2>My Vehicles</h2>
    <button class="add-vehicle-btn" (click)="openAddVehicleModal()">
      <i class="fas fa-plus"></i>
      Add Vehicle
    </button>
  </div>

  <div class="vehicle-cards">
    <div class="vehicle-card" *ngFor="let vehicle of vehicles; trackBy: trackByVehicleId">
      <!-- Vehicle Image -->
      <img [src]="vehicle.image" [alt]="vehicle.year + ' ' + vehicle.name" class="vehicle-img" />

      <!-- Vehicle Details -->
      <div class="vehicle-details">
        <!-- Title & Actions -->
        <div class="card-title">
          <h3>{{ vehicle.year }} {{ vehicle.name }}</h3>
          <div class="card-actions">
            <button type="button" class="btn btn-warning" (click)="editVehicle(vehicle)" title="Edit Vehicle">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="btn btn-danger" (click)="confirmDelete(vehicle.id)" title="Delete Vehicle">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- Plate & Color -->
        <p class="plate-info">{{ vehicle.color }} â€¢ {{ vehicle.plateNumber }}</p>

        <!-- Mileage Info -->
        <div class="info-row">
          <span>Current Mileage:</span>
          <span class="miles">{{ vehicle.currentMileage }} miles</span>
        </div>

        <!-- Service Info -->
        <div class="info-row">
          <span>Next Service Due:</span>
          <span class="service-due">{{ vehicle.nextServiceDue }}</span>
        </div>

        <!-- Service Button -->
        <button type="button" class="service-btn" (click)="openScheduleServiceModal(vehicle)">
          Schedule Service
        </button>
      </div>
    </div>
  </div>

  <!-- Shared Add/Edit Vehicle Modal -->
  <div class="modal-overlay" *ngIf="showAddVehicleModal" (click)="closeAddVehicleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditMode ? 'Edit Vehicle' : 'Add New Vehicle' }}</h3>
        <button class="close-btn" (click)="closeAddVehicleModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form class="modal-form" (ngSubmit)="submitVehicle()" #vehicleForm="ngForm">
        <div class="form-row">
          <div class="form-group">
            <label for="vehicleName">Vehicle Name</label>
            <input
              type="text"
              id="vehicleName"
              name="vehicleName"
              [(ngModel)]="newVehicle.name"
              placeholder="e.g. Toyota Camry"
              required
            />
          </div>
          <div class="form-group">
            <label for="vehicleYear">Year</label>
            <input
              type="number"
              id="vehicleYear"
              name="vehicleYear"
              [(ngModel)]="newVehicle.year"
              placeholder="2024"
              required
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="vehicleColor">Color</label>
            <input
              type="text"
              id="vehicleColor"
              name="vehicleColor"
              [(ngModel)]="newVehicle.color"
              placeholder="e.g. Blue"
              required
            />
          </div>
          <div class="form-group">
            <label for="plateNumber">Plate Number</label>
            <input
              type="text"
              id="plateNumber"
              name="plateNumber"
              [(ngModel)]="newVehicle.plateNumber"
              placeholder="e.g. ABC-123"
              required
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="ownerEmail">Owner Email</label>
            <input
              type="email"
              id="ownerEmail"
              name="ownerEmail"
              [(ngModel)]="newVehicle.email"
              placeholder="e.g. owner@email.com"
              required
            />
          </div>
          <div class="form-group">
            <label for="ownerPassword">Password</label>
            <input
              type="password"
              id="ownerPassword"
              name="ownerPassword"
              [(ngModel)]="newVehicle.password"
              placeholder="Enter password"
              required
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="currentMileage">Current Mileage</label>
            <input
              type="text"
              id="currentMileage"
              name="currentMileage"
              [(ngModel)]="newVehicle.currentMileage"
              placeholder="45,000"
              required
            />
          </div>
          <div class="form-group">
            <label for="vehicleImage">Vehicle Image</label>
            <input
              type="file"
              id="vehicleImage"
              name="vehicleImage"
              (change)="onImageSelected($event)"
              accept="image/*"
              class="file-input"
              required
            />
            <div class="file-input-wrapper" [class.has-image]="imagePreview">
              <div class="file-input-display" (click)="triggerFileInput()">
                <img *ngIf="imagePreview" [src]="imagePreview" alt="Preview" class="image-preview" />
                <div *ngIf="!imagePreview" class="upload-placeholder">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>Choose Vehicle Image</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-btn" (click)="closeAddVehicleModal()">Cancel</button>
          <button type="submit" class="submit-btn" [disabled]="!vehicleForm.valid">
            <i [class.fa-plus]="!isEditMode" [class.fa-edit]="isEditMode"></i>
            {{ isEditMode ? 'Update Vehicle' : 'Add Vehicle' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Service Scheduling Modal -->
  <div class="modal-overlay" *ngIf="showScheduleServiceModal" (click)="closeScheduleServiceModal()" (keydown.escape)="closeScheduleServiceModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Schedule Service for {{ selectedVehicleForService?.year }} {{ selectedVehicleForService?.name }}</h3>
        <button class="close-btn" (click)="closeScheduleServiceModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form class="service-form" [formGroup]="serviceForm" (ngSubmit)="scheduleService()">
        <div class="form-row">
          <div class="form-group">
            <label for="serviceTitle">Service Title</label>
            <input type="text" id="serviceTitle" name="serviceTitle" formControlName="title" required placeholder="e.g., Oil Change & Filter">
            <div class="error-message" *ngIf="getFieldError('title')">
              {{ getFieldError('title') }}
            </div>
          </div>
          <div class="form-group">
            <label for="servicePrice">Price ($)</label>
            <input type="number" id="servicePrice" name="servicePrice" formControlName="price" required placeholder="0.00">
            <div class="error-message" *ngIf="getFieldError('price')">
              {{ getFieldError('price') }}
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="serviceDescription">Description</label>
            <input type="text" id="serviceDescription" name="serviceDescription" formControlName="description" required placeholder="e.g., Regular maintenance service">
            <div class="error-message" *ngIf="getFieldError('description')">
              {{ getFieldError('description') }}
            </div>
          </div>
          <div class="form-group">
            <label for="serviceType">Service Type</label>
            <select id="serviceType" name="serviceType" formControlName="serviceType" required>
              <option value="General Service">General Service</option>
              <option value="Oil Change">Oil Change</option>
              <option value="Brake Service">Brake Service</option>
              <option value="Tire Service">Tire Service</option>
              <option value="Engine Repair">Engine Repair</option>
              <option value="AC Repair">AC Repair</option>
              <option value="Electrical">Electrical</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="technician">Technician</label>
            <input type="text" id="technician" name="technician" formControlName="technician" required placeholder="e.g., John Smith">
            <div class="error-message" *ngIf="getFieldError('technician')">
              {{ getFieldError('technician') }}
            </div>
          </div>
          <div class="form-group">
            <label for="serviceDate">Service Date</label>
            <input type="date" id="serviceDate" name="serviceDate" formControlName="date" required>
            <div class="error-message" *ngIf="getFieldError('date')">
              {{ getFieldError('date') }}
            </div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="location">Location</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <input 
                type="text" 
                id="location" 
                name="location" 
                formControlName="location" 
                required 
                placeholder="Enter the location or click to get your current location"
                style="flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 0.75rem 1rem; color: var(--light); font-size: 1rem;"
              />
              <button 
                type="button" 
                (click)="getCurrentLocation()" 
                [disabled]="isGettingLocation"
                style="background: var(--primary-color); color: white; border: none; border-radius: 8px; padding: 0.75rem; cursor: pointer; transition: all 0.3s ease; min-width: 100px;"
                title="Get current location"
              >
                <i class="fas fa-location-arrow" *ngIf="!isGettingLocation"></i>
                <i class="fas fa-spinner fa-spin" *ngIf="isGettingLocation"></i>
              {{ isGettingLocation ? 'Loading...' : 'My Location' }}
              </button>
            </div>
            <div class="error-message" *ngIf="getFieldError('location')">
              {{ getFieldError('location') }}
            </div>
          </div>
          <div class="form-group">
            <label for="rating">Expected Rating</label>
            <select id="rating" name="rating" formControlName="rating" required>
              <option value="5">5 Stars - Excellent</option>
              <option value="4">4 Stars - Very Good</option>
              <option value="3">3 Stars - Good</option>
              <option value="2">2 Stars - Fair</option>
              <option value="1">1 Star - Poor</option>
            </select>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeScheduleServiceModal()">Cancel</button>
          <button type="submit" class="btn btn-danger" [disabled]="serviceForm.invalid">
            <i class="fas fa-plus"></i>
            Schedule Service
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
