<main class="main-content">
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">Service History</h1>
      <p class="page-subtitle">
        Track your vehicle maintenance and service records
      </p>
    </div>
    <div class="filters-section">
      <div class="filter-group">
        <select class="filter-select" id="serviceFilter">
          <option value="all">All Services</option>
          <option value="oil-change">Oil Change & Filter</option>
          <option value="brake-service">Brake Service</option>
          <option value="tire-service">Tire Service</option>
          <option value="engine-repair">Engine Repair</option>
          <option value="transmission">Transmission</option>
        </select>
        <select class="filter-select" id="vehicleFilter">
          <option value="all">All Vehicles</option>
          <option value="toyota-camry">Toyota Camry</option>
          <option value="honda-crv">Honda CR-V</option>
          <option value="ford-f150">Ford F-150</option>
          <option value="bmw-x3">BMW X3</option>
        </select>
      </div>
      <button
        class="add-service-btn"
        id="addServiceBtn"
        (click)="openAddServiceModal()"
      >
        <i class="fas fa-plus"></i>
        Add Service
      </button>
    </div>
    <div class="service-list">
      <div
        *ngFor="let service of serviceHistory; trackBy: trackByServiceId"
        class="service-card"
        [attr.data-type]="service.serviceType"
        [attr.data-vehicle]="service.vehicle"
      >
        <div class="service-header">
          <div class="service-title-group">
            <h3 class="service-title">{{ service.title }}</h3>
            <span class="status-badge">{{ service.status }}</span>
          </div>
          <div class="price-rating-group">
            <span class="service-price">${{ service.price }}</span>
            <div class="rating">
              <span
                class="star"
                *ngFor="let star of [0, 1, 2, 3, 4]; let i = index"
                [class.empty]="i >= service.rating"
                >★</span
              >
            </div>
          </div>
        </div>
        <div class="service-details">
          <div class="detail-item">
            <i class="fas fa-calendar-alt detail-icon"></i>
            <span>{{ service.serviceDate }}</span>
          </div>
          <div class="detail-item">
            <i class="fas fa-user-cog detail-icon"></i>
            <span>{{ service.technician }}</span>
          </div>
          <div class="detail-item">
            <i class="fas fa-car detail-icon"></i>
            <span>{{ service.vehicle }}</span>
          </div>
        </div>
        <div class="action-buttons">
          <a href="#" class="btn btn-primary">Book Again</a>
          <a href="#" class="btn btn-secondary">Download Invoice</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Service Modal -->
  <div
    class="modal-overlay"
    *ngIf="showAddServiceModal"
    (click)="closeAddServiceModal()"
    (keydown.escape)="closeAddServiceModal()"
  >
    <div
      class="modal-content"
      (click)="$event.stopPropagation()"
      (keydown)="$event.stopPropagation()"
    >
      <div class="modal-header">
        <h3>Add New Service</h3>
        <button class="close-btn" (click)="closeAddServiceModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form
        class="service-form"
        [formGroup]="addServiceForm"
        (ngSubmit)="addNewService()"
      >
        <div class="form-row">
          <div class="form-group">
            <label for="serviceTitle">Service Title</label>
            <input
              type="text"
              id="serviceTitle"
              name="serviceTitle"
              formControlName="title"
              required
              placeholder="e.g., Oil Change & Filter"
            />
            <div class="error-message" *ngIf="getFieldError('title')">
              {{ getFieldError('title') }}
            </div>
          </div>
          <div class="form-group">
            <label for="servicePrice">Price ($)</label>
            <input
              type="number"
              id="servicePrice"
              name="servicePrice"
              formControlName="price"
              required
              placeholder="0.00"
            />
            <div class="error-message" *ngIf="getFieldError('price')">
              {{ getFieldError('price') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="serviceDescription">Description</label>
            <input
              type="text"
              id="serviceDescription"
              name="serviceDescription"
              formControlName="description"
              required
              placeholder="e.g., Regular maintenance service"
            />
            <div class="error-message" *ngIf="getFieldError('description')">
              {{ getFieldError('description') }}
            </div>
          </div>
          <div class="form-group">
            <label for="serviceType">Service Type</label>
            <select id="serviceType" name="serviceType" formControlName="serviceType" required>
              <option value="General Service">General Service</option>
              <option value="Oil Change">Oil Change</option>
              <option value="Brake Service">Brake Service</option>
              <option value="Tire Service">Tire Service</option>
              <option value="Engine Repair">Engine Repair</option>
              <option value="AC Repair">AC Repair</option>
              <option value="Electrical">Electrical</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="technician">Technician</label>
            <input
              type="text"
              id="technician"
              name="technician"
              formControlName="technician"
              required
              placeholder="e.g., John Smith"
            />
            <div class="error-message" *ngIf="getFieldError('technician')">
              {{ getFieldError('technician') }}
            </div>
          </div>
          <div class="form-group">
            <label for="vehicle">Vehicle</label>
            <input
              type="text"
              id="vehicle"
              name="vehicle"
              formControlName="vehicle"
              required
              placeholder="e.g., Toyota Camry"
            />
           <div style="display: flex; gap: 0.5rem; align-items: center;">
             <input 
               type="text" 
               id="location" 
               name="location" 
               formControlName="location" 
               required 
               placeholder="أدخل الموقع أو اضغط للحصول على موقعك الحالي"
               style="flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 0.75rem 1rem; color: var(--light); font-size: 1rem;"
             />
             <button 
               type="button" 
               (click)="getCurrentLocation()" 
               [disabled]="isGettingLocation"
               style="background: var(--primary-color); color: white; border: none; border-radius: 8px; padding: 0.75rem; cursor: pointer; transition: all 0.3s ease; min-width: 100px;"
               title="الحصول على الموقع الحالي"
             >
               <i class="fas fa-location-arrow" *ngIf="!isGettingLocation"></i>
               <i class="fas fa-spinner fa-spin" *ngIf="isGettingLocation"></i>
               {{ isGettingLocation ? 'جاري...' : 'موقعي' }}
             </button>
           </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="serviceDate">Service Date</label>
            <input
              type="date"
              id="serviceDate"
              name="serviceDate"
              formControlName="date"
              required
              [min]="getTodayDate()"
              style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 0.75rem 1rem; color: var(--light); font-size: 1rem;"
            />
            <div class="error-message" *ngIf="getFieldError('date')">
              {{ getFieldError('date') }}
            </div>
          </div>
          <div class="form-group">
            <label for="location">Location</label>
            <div class="error-message" *ngIf="getFieldError('location')">
              {{ getFieldError('location') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="rating">Expected Rating</label>
            <select id="rating" name="rating" formControlName="rating" required>
              <option value="5">5 Stars - Excellent</option>
              <option value="4">4 Stars - Very Good</option>
              <option value="3">3 Stars - Good</option>
              <option value="2">2 Stars - Fair</option>
              <option value="1">1 Star - Poor</option>
            </select>
          </div>
        </div>

        <!-- Error Message -->
        <div class="error-message global-error" *ngIf="errorMessage">
          <i class="fas fa-exclamation-triangle"></i>
          {{ errorMessage }}
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="closeAddServiceModal()"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="btn btn-primary"
            [disabled]="addServiceForm.invalid || isLoading"
          >
            <span *ngIf="!isLoading">
              <i class="fas fa-plus"></i>
              Add Service
            </span>
            <span *ngIf="isLoading" class="loading">
              <i class="fas fa-spinner fa-spin"></i>
              Adding Service...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</main>
