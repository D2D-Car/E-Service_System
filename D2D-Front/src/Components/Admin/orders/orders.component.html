<div class="orders-container" (click)="closeDropdowns()">
  <!-- Header Section -->
  <h2 class="section-titles">Order DASHBOARD</h2>
  <p class="section-subtitles">
    Make informed decisions with real-time order data
  </p>

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <!-- Date Filter Dropdown -->
      <div class="dropdown" (click)="$event.stopPropagation()">
        <button class="btn btn-outline-light dropdown-toggle" [class.active]="showDateDropdown"
          (click)="toggleDateDropdown()">
          üìÖ {{ selectedDateRange }}
        </button>
        <ul *ngIf="showDateDropdown" class="dropdown-menu show">
          <li>
            <a class="dropdown-item" (click)="selectDateRange('Aug 1 - Aug 6, 2024')">Aug 1 - Aug 6, 2024</a>
          </li>
          <li>
            <a class="dropdown-item" (click)="selectDateRange('Jul 1 - Jul 31, 2024')">Jul 1 - Jul 31, 2024</a>
          </li>
          <li>
            <a class="dropdown-item" (click)="selectDateRange('Jun 1 - Jun 30, 2024')">Jun 1 - Jun 30, 2024</a>
          </li>
          <li>
            <a class="dropdown-item" (click)="selectDateRange('May 1 - May 31, 2024')">May 1 - May 31, 2024</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="header-right">
      <!-- More Actions Dropdown -->
      <div class="dropdown" (click)="$event.stopPropagation()">
        <button class="btn btn-outline-light dropdown-toggle" [class.active]="showMoreActions"
          (click)="toggleMoreActions()">
          ‚öôÔ∏è {{ selectedAction }}
        </button>
        <ul *ngIf="showMoreActions" class="dropdown-menu show">
          <li><a class="dropdown-item" (click)="selectMoreAction('Export CSV')">üìä Export CSV</a></li>
          <li><a class="dropdown-item" (click)="selectMoreAction('Analytics')">üìà Analytics</a></li>
          <li><a class="dropdown-item" (click)="selectMoreAction('Settings')">‚öôÔ∏è Settings</a></li>
        </ul>
      </div>


    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card">
      <span class="stat-label">Total Orders</span>
      <div class="stat-value">{{ totalOrders }}</div>
      <div class="stat-change positive">
        ‚ñ≤ 25.2% last week
        <div class="mini-chart yellow"></div>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-label">Order Items</span>
      <div class="stat-value">{{ orderItems }}</div>
      <div class="stat-change positive">
        ‚ñ≤ 15.2% last week
        <div class="mini-chart blue"></div>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-label">Return Orders</span>
      <div class="stat-value">{{ returnOrders }}</div>
      <div class="stat-change negative">
        ‚ñº -1.2% last week
        <div class="mini-chart red"></div>
      </div>
    </div>
    <div class="stat-card">
      <span class="stat-label">Fulfilled Orders</span>
      <div class="stat-value">{{ fulfilledOrders }}</div>
      <div class="stat-change positive">
        ‚ñ≤ 12.2% last week
        <div class="mini-chart green"></div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-container">
    <div class="filters-left btn-group">
      <button *ngFor="let filter of filters" class="btn btn-outline-light" [class.active]="selectedFilter === filter"
        (click)="setFilter(filter)">
        {{ filter }}
      </button>
    </div>
  </div>

  <!-- Table Container -->
  <div class="table-container">
    <table class="orders-table">
      <thead>
        <tr>
          <th><input type="checkbox" title="Select all" /></th>
          <th>Order ID</th>
          <th>Date</th>
          <th>Customer</th>
          <th>Payment Status</th>
          <th>Total Amount</th>
          <th>Delivery Location</th>
          <th>Items Count</th>
          <th>Fulfillment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of filteredOrders; trackBy: trackByOrderId">
          <td>
            <input type="checkbox" [title]="'Select order ' + order.id" />
          </td>
          <td>
            <strong>{{ order.orderId }}</strong>
          </td>
          <td>{{ order.date }}</td>
          <td>
            <div class="customer-name">{{ order.customer }}</div>
          </td>
          <td>
            <span class="status-badge" [class.pending]="order.payment === 'Pending'"
              [class.success]="order.payment === 'Success'">
              {{ order.payment }}
            </span>
          </td>
          <td>
            <strong>{{
              order.amount | currency : "USD" : "symbol" : "1.2-2"
              }}</strong>
          </td>
          <td>{{ order.location }}</td>
          <td>{{ order.items }} items</td>
          <td>
            <span class="fulfillment-badge" [class.unfulfilled]="order.fulfillment === 'Unfulfilled'"
              [class.fulfilled]="order.fulfillment === 'Fulfilled'">
              {{ order.fulfillment }}
            </span>
          </td>
          <td>
            <button class="action-btn view" (click)="viewOrder(order.id!)" title="View Order">
              üëÅÔ∏è
            </button>
            <button class="action-btn edit" (click)="editOrder(order.id!)" title="Edit Order">
              ‚úèÔ∏è
            </button>
            <button class="action-btn delete" (click)="deleteOrder(order.id!)" title="Delete Order">
              üóëÔ∏è
            </button>
            <button class="action-btn assign" (click)="openAssignModal(order)" title="Assign">
              üë§
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div *ngIf="filteredOrders.length === 0" class="empty-state">
      <div class="empty-icon">üì¶</div>
      <div class="empty-title">No Orders Found</div>
      <div class="empty-description">
        There are no orders matching your current filter criteria.
      </div>
      <button class="empty-action" (click)="setFilter('All')">
        Show All Orders
      </button>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div class="modal-overlay" [class.active]="showOrderDetailsModal" (click)="closeOrderDetailsModal()">
    <div class="order-details-modal" (click)="$event.stopPropagation()" *ngIf="selectedOrder">

      <!-- Modal Header -->
      <div class="modal-header">
        <div class="header-content">
          <i class="fas fa-shopping-cart header-icon"></i>
          <span class="header-title">Order Details</span>
        </div>
        <button class="close-btn" (click)="closeOrderDetailsModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Order Content -->
      <div class="order-content">

        <!-- Order ID and Date -->
        <div class="order-header">
          <h3 class="order-id">{{ selectedOrder.orderId }}</h3>
          <p class="order-date">{{ selectedOrder.date }}</p>
        </div>

        <!-- Order Status -->
        <div class="order-status-section">
          <div class="status-item">
            <div class="status-label">Payment Status</div>
            <div class="status-badge" [class.pending]="selectedOrder.payment === 'Pending'"
              [class.success]="selectedOrder.payment === 'Success'">
              {{ selectedOrder.payment }}
            </div>
          </div>
          <div class="status-item">
            <div class="status-label">Fulfillment</div>
            <div class="fulfillment-badge" [class.unfulfilled]="selectedOrder.fulfillment === 'Unfulfilled'"
              [class.fulfilled]="selectedOrder.fulfillment === 'Fulfilled'">
              {{ selectedOrder.fulfillment }}
            </div>
          </div>
        </div>

        <!-- Customer and Service Details -->
        <div class="details-section">
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-user"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Customer</div>
              <div class="detail-value">{{ selectedOrder.customer }}</div>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-tools"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Service Type</div>
              <div class="detail-value">{{ selectedOrder.serviceType }}</div>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-car"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Vehicle</div>
              <div class="detail-value">{{ selectedOrder.vehicle }}</div>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-user-md"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Technician</div>
              <div class="detail-value">{{ selectedOrder.technician }}</div>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Location</div>
              <div class="detail-value">{{ selectedOrder.location }}</div>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="detail-content">
              <div class="detail-label">Total Amount</div>
              <div class="detail-value amount">{{ selectedOrder.amount | currency : "USD" : "symbol" : "1.2-2" }}</div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="modal-actions">
          <button class="action-btn edit-btn" (click)="editOrder(selectedOrder.id!); closeOrderDetailsModal()">
            <i class="fas fa-edit"></i> Edit Order
          </button>
          <button class="action-btn delete-btn" (click)="deleteOrder(selectedOrder.id!); closeOrderDetailsModal()">
            <i class="fas fa-trash"></i> Delete Order
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div class="modal-overlay" [class.active]="showEditOrderModal" (click)="closeEditOrderModal()">
    <div class="order-edit-modal" (click)="$event.stopPropagation()" *ngIf="orderToEdit">

      <!-- Modal Header -->
      <div class="modal-header">
        <div class="header-content">
          <i class="fas fa-edit header-icon"></i>
          <span class="header-title">Edit Order</span>
        </div>
        <button class="close-btn" (click)="closeEditOrderModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Edit Form -->
      <div class="edit-form-content">
        <form (ngSubmit)="saveOrderChanges()">
          <!-- Order ID and Date -->
          <div class="form-row">
            <div class="form-group">
              <label for="orderId">Order ID</label>
              <input type="text" id="orderId" name="orderId" [(ngModel)]="orderToEdit.orderId" readonly
                class="form-control">
            </div>
            <div class="form-group">
              <label for="date">Date</label>
              <input type="text" id="date" name="date" [(ngModel)]="orderToEdit.date" class="form-control">
            </div>
          </div>

          <!-- Status Fields -->
          <div class="form-row">
            <div class="form-group">
              <label for="payment">Payment Status</label>
              <select id="payment" name="payment" [(ngModel)]="orderToEdit.payment" class="form-control">
                <option value="Pending">Pending</option>
                <option value="Success">Success</option>
              </select>
            </div>
            <div class="form-group">
              <label for="fulfillment">Fulfillment Status</label>
              <select id="fulfillment" name="fulfillment" [(ngModel)]="orderToEdit.fulfillment" class="form-control">
                <option value="Unfulfilled">Unfulfilled</option>
                <option value="Fulfilled">Fulfilled</option>
              </select>
            </div>
          </div>

          <!-- Customer and Service Details -->
          <div class="form-row">
            <div class="form-group">
              <label for="customer">Customer</label>
              <input type="text" id="customer" name="customer" [(ngModel)]="orderToEdit.customer" class="form-control">
            </div>
            <div class="form-group">
              <label for="serviceType">Service Type</label>
              <input type="text" id="serviceType" name="serviceType" [(ngModel)]="orderToEdit.serviceType"
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="vehicle">Vehicle</label>
              <input type="text" id="vehicle" name="vehicle" [(ngModel)]="orderToEdit.vehicle" class="form-control">
            </div>
            <div class="form-group">
              <label for="technician">Technician</label>
              <input type="text" id="technician" name="technician" [(ngModel)]="orderToEdit.technician"
                class="form-control">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="location">Location</label>
              <input type="text" id="location" name="location" [(ngModel)]="orderToEdit.location" class="form-control">
            </div>
            <div class="form-group">
              <label for="amount">Amount</label>
              <input type="number" id="amount" name="amount" [(ngModel)]="orderToEdit.amount" class="form-control">
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button type="button" class="cancel-btn" (click)="closeEditOrderModal()">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="save-btn">
              <i class="fas fa-save"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Assignment Modal -->
  <div class="modal-overlay" [class.active]="showAssignModal" (click)="closeAssignModal()">
    <div class="order-edit-modal" (click)="$event.stopPropagation()" *ngIf="showAssignModal">
      <div class="modal-header">
        <div class="header-content">
          <i class="fas fa-user-plus header-icon"></i>
          <span class="header-title">Assign Order</span>
        </div>
        <button class="close-btn" (click)="closeAssignModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="edit-form-content" *ngIf="!loadingAssignments; else loadTpl">
        <div *ngIf="assignmentError" class="error">{{assignmentError}}</div>
        <h4>Drivers</h4>
        <div class="user-list">
          <label *ngFor="let d of drivers" class="user-row">
            <input type="checkbox" [checked]="selectedDriverIds.has(d.uid)" (change)="toggleDriver(d.uid)" />
            <span class="name">{{ d.displayName || d.email }}</span>
            <span class="availability-tag" [class.available]="d['availability']==='Available'" [class.unavailable]="d['availability']!=='Available'">{{ d['availability'] || 'Unknown' }}</span>
          </label>
        </div>
        <h4>Technicians</h4>
        <div class="user-list">
          <label *ngFor="let t of technicians" class="user-row">
            <input type="checkbox" [checked]="selectedTechnicianIds.has(t.uid)" (change)="toggleTechnician(t.uid)" />
            <span class="name">{{ t.displayName || t.email }}</span>
            <span class="availability-tag" [class.available]="t['availability']==='Available'" [class.unavailable]="t['availability']!=='Available'">{{ t['availability'] || 'Unknown' }}</span>
          </label>
        </div>
        <div class="form-actions">
          <button type="button" class="cancel-btn" (click)="closeAssignModal()"><i class="fas fa-times"></i> Cancel</button>
          <button type="button" class="save-btn" (click)="saveAssignment()"><i class="fas fa-save"></i> Save</button>
        </div>
      </div>
      <ng-template #loadTpl>
        <div class="loading">Loading users...</div>
      </ng-template>
    </div>
  </div>
</div>